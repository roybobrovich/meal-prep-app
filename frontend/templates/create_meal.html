<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Meal</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>üç≥ Create Meal</h1>
        
        <div class="menu">
            <a href="/" class="button">Home</a>
            <a href="/meals" class="button">View Saved Meals</a>
        </div>

        <!-- Meal Info -->
        <div class="section">
            <h2>Meal Information</h2>
            <form method="POST" action="/update-meal-info">
                <input type="text" name="name" value="{{ meal.name }}" placeholder="Meal name" required>
                <input type="number" name="servings" value="{{ meal.servings }}" min="1" placeholder="Servings" required>
                <button type="submit">Update Info</button>
            </form>
        </div>

        <!-- Search for Ingredients -->
        <div class="section">
            <h2>Add Ingredients</h2>
<form method="POST" action="/search-ingredient" id="ingredientSearchForm">
    <div class="autocomplete-container">
        <input 
            type="text" 
            name="query" 
            id="ingredientInput"
            placeholder="Search for food (e.g., chicken)" 
            value="{{ query if query else '' }}" 
            autocomplete="off"
            required
        >
        <div id="ingredient-autocomplete-list" class="autocomplete-items"></div>
    </div>
    <button type="submit">Search</button>
</form>

<style>
    .autocomplete-container {
        position: relative;
        display: inline-block;
        width: 100%;
        max-width: 400px;
    }

    .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
        background-color: white;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0px 4px 6px rgba(0,0,0,0.1);
    }

    .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        background-color: #fff;
        border-bottom: 1px solid #d4d4d4;
        font-size: 14px;
    }

    .autocomplete-items div:hover {
        background-color: #e9e9e9;
    }

    .autocomplete-active {
        background-color: #4CAF50 !important;
        color: white;
    }
</style>

<script>
    const ingredientInput = document.getElementById('ingredientInput');
    const ingredientAutocompleteList = document.getElementById('ingredient-autocomplete-list');
    let currentFocus = -1;
    let debounceTimer;

    ingredientInput.addEventListener('input', function() {
        const value = this.value;
        
        clearTimeout(debounceTimer);
        closeAllLists();
        
        if (value.length < 2) {
            return;
        }
        
        currentFocus = -1;
        
        debounceTimer = setTimeout(async () => {
            try {
                const response = await fetch(`/api/autocomplete?q=${encodeURIComponent(value)}`);
                const suggestions = await response.json();
                
                if (suggestions.length === 0) {
                    return;
                }
                
                suggestions.forEach(suggestion => {
                    const div = document.createElement('div');
                    div.innerHTML = suggestion.name;
                    div.addEventListener('click', function() {
                        ingredientInput.value = suggestion.name;
                        closeAllLists();
                    });
                    ingredientAutocompleteList.appendChild(div);
                });
                
            } catch (error) {
                console.error('Autocomplete error:', error);
            }
        }, 300);
    });

    ingredientInput.addEventListener('keydown', function(e) {
        let items = ingredientAutocompleteList.getElementsByTagName('div');
        
        if (e.keyCode === 40) {
            currentFocus++;
            addActive(items);
            e.preventDefault();
        } else if (e.keyCode === 38) {
            currentFocus--;
            addActive(items);
            e.preventDefault();
        } else if (e.keyCode === 13) {
            if (currentFocus > -1) {
                e.preventDefault();
                if (items) items[currentFocus].click();
            }
        } else if (e.keyCode === 27) {
            closeAllLists();
        }
    });

    function addActive(items) {
        if (!items) return false;
        removeActive(items);
        if (currentFocus >= items.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = (items.length - 1);
        items[currentFocus].classList.add('autocomplete-active');
    }

    function removeActive(items) {
        for (let i = 0; i < items.length; i++) {
            items[i].classList.remove('autocomplete-active');
        }
    }

    function closeAllLists() {
        ingredientAutocompleteList.innerHTML = '';
        currentFocus = -1;
    }

    document.addEventListener('click', function(e) {
        if (e.target !== ingredientInput) {
            closeAllLists();
        }
    });
</script>

            {% if search_results %}
            <div style="margin-top: 20px;">
                <h3>Search Results:</h3>
                {% for food in search_results %}
                <div class="food-item">
                    <strong>{{ food.description }}</strong>
                    {% if food.brandName %}
                    <br><em>{{ food.brandName }}</em>
                    {% endif %}
                    <br>
                    <small>
                        Per 100g: 
                        Protein: {{ food.nutrients.protein }}g | 
                        Fat: {{ food.nutrients.fat }}g | 
                        Carbs: {{ food.nutrients.carbs }}g | 
                        Calories: {{ food.nutrients.calories }}
                    </small>
                    
                    <form method="POST" action="/add-ingredient" style="margin-top: 10px;">
                        <input type="hidden" name="fdcId" value="{{ food.fdcId }}">
                        <input type="hidden" name="description" value="{{ food.description }}">
                        <input type="hidden" name="brandName" value="{{ food.brandName }}">
                        <input type="hidden" name="protein" value="{{ food.nutrients.protein }}">
                        <input type="hidden" name="fat" value="{{ food.nutrients.fat }}">
                        <input type="hidden" name="carbs" value="{{ food.nutrients.carbs }}">
                        <input type="hidden" name="calories" value="{{ food.nutrients.calories }}">
                        <input type="number" name="grams" value="100" min="1" placeholder="Grams" required>
                        <button type="submit">Add to Meal</button>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Current Ingredients -->
        <div class="section">
            <h2>Current Ingredients</h2>
            {% if meal.ingredients %}
                {% for ingredient in meal.ingredients %}
                <div class="ingredient-item">
                    <strong>{{ ingredient.description }}</strong> - {{ ingredient.grams }}g
                    <br>
                    <small>
                        Protein: {{ "%.1f"|format(ingredient.nutrients.protein * ingredient.grams / 100) }}g | 
                        Fat: {{ "%.1f"|format(ingredient.nutrients.fat * ingredient.grams / 100) }}g | 
                        Carbs: {{ "%.1f"|format(ingredient.nutrients.carbs * ingredient.grams / 100) }}g | 
                        Calories: {{ "%.0f"|format(ingredient.nutrients.calories * ingredient.grams / 100) }}
                    </small>
                    <form method="POST" action="/remove-ingredient/{{ loop.index0 }}" style="display:inline;">
                        <button type="submit" style="background-color: #f44336;">Remove</button>
                    </form>
                </div>
                {% endfor %}
            {% else %}
                <p>No ingredients added yet. Search and add ingredients above.</p>
            {% endif %}
        </div>

        <!-- Nutrition Summary -->
        {% if meal.ingredients %}
        <div class="section" style="background-color: #e8f5e9;">
            <h2>Nutrition Summary</h2>
            <div style="padding: 10px;">
                <h3>Total:</h3>
                <p>
                    Protein: {{ nutrition.total.protein }}g | 
                    Fat: {{ nutrition.total.fat }}g | 
                    Carbs: {{ nutrition.total.carbs }}g | 
                    Calories: {{ nutrition.total.calories }}
                </p>
                
                <h3>Per Serving ({{ meal.servings }} servings):</h3>
                <p>
                    Protein: {{ nutrition.perServing.protein }}g | 
                    Fat: {{ nutrition.perServing.fat }}g | 
                    Carbs: {{ nutrition.perServing.carbs }}g | 
                    Calories: {{ nutrition.perServing.calories }}
                </p>
            </div>

            <form method="POST" action="/save-meal" style="display:inline;">
                <button type="submit" style="background-color: #FF9800; font-size: 16px; padding: 12px 30px;">
                    üíæ Save Meal
                </button>
            </form>

            <form method="POST" action="/clear-meal" style="display:inline;">
                <button type="submit" style="background-color: #f44336;" 
                        onclick="return confirm('Clear all ingredients?')">
                    üóëÔ∏è Clear Meal
                </button>
            </form>
        </div>
        {% endif %}
    </div>
</body>
</html>
